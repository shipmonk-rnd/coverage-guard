#!/usr/bin/env php
<?php declare(strict_types=1);

use ShipMonk\CoverageGuard\Cli\CliParser;
use ShipMonk\CoverageGuard\Cli\CommandRegistry;
use ShipMonk\CoverageGuard\Cli\CommandRunner;
use ShipMonk\CoverageGuard\Cli\HelpRenderer;
use ShipMonk\CoverageGuard\Cli\ParameterResolver;
use ShipMonk\CoverageGuard\Command\CheckCommand;
use ShipMonk\CoverageGuard\Command\ConvertCommand;
use ShipMonk\CoverageGuard\Command\MergeCommand;
use ShipMonk\CoverageGuard\Command\PatchCoverageCommand;
use ShipMonk\CoverageGuard\Coverage\CoverageMerger;
use ShipMonk\CoverageGuard\Exception\ErrorException;
use ShipMonk\CoverageGuard\Extractor\ExtractorFactory;
use ShipMonk\CoverageGuard\Printer;
use ShipMonk\CoverageGuard\Utils\ConfigResolver;
use ShipMonk\CoverageGuard\Utils\PatchParser;

$autoloadPaths = [
    __DIR__ . '/../vendor/autoload.php',
    __DIR__ . '/../../../autoload.php',
];

foreach ($autoloadPaths as $autoloadPath) {
    if (file_exists($autoloadPath)) {
        require $autoloadPath;
        break;
    }
}

$cwd = getcwd();
if ($cwd === false) {
    throw new LogicException('Cannot determine current working directory');
}

$noColor = in_array('--no-color', $argv, true)
    || getenv('NO_COLOR') !== false
    || (!stream_isatty(STDOUT) && !in_array('--color', $argv, true));

$printer = new Printer(STDOUT, $noColor);

try {
    $patchParser = new PatchParser($cwd, $printer);
    $configResolver = new ConfigResolver($cwd);
    $extractorFactory = new ExtractorFactory();

    $registry = new CommandRegistry();
    $registry->register(new CheckCommand($cwd, $printer, $configResolver, $patchParser, $extractorFactory));
    $registry->register(new MergeCommand($extractorFactory, new CoverageMerger()));
    $registry->register(new ConvertCommand($extractorFactory));
    $registry->register(new PatchCoverageCommand($printer, $patchParser, $configResolver, $extractorFactory));

    $parameterResolver = new ParameterResolver();

    $runner = new CommandRunner(
        $registry,
        new CliParser(),
        $parameterResolver,
        new HelpRenderer($parameterResolver)
    );
    $exitCode = $runner->run($argv, $printer);
    exit($exitCode);

} catch (ErrorException $e) {
    $printer->printLine('');
    $printer->printLine('⚠️  <orange>Error:</orange> ' . $e->getMessage());
    $printer->printLine('');
    exit(1);

} catch (Throwable $e) {
    $printer->printLine('');
    $printer->printLine('‼️  <red>Internal error:</red> ' . $e::class . ': ' . $e->getMessage());
    $printer->printLine($e->getTraceAsString());
    exit(1);
}
