#!/usr/bin/env php
<?php declare(strict_types=1);

use ShipMonk\CoverageGuard\CoverageGuard;
use ShipMonk\CoverageGuard\Exception\ErrorException;
use ShipMonk\CoverageGuard\Exception\HelpException;
use ShipMonk\CoverageGuard\Initializer;
use ShipMonk\CoverageGuard\PathHelper;
use ShipMonk\CoverageGuard\Printer;
use ShipMonk\CoverageGuard\Report\ErrorFormatter;

$autoloadPaths = [
    __DIR__ . '/../vendor/autoload.php',
    __DIR__ . '/../../../autoload.php',
];

foreach ($autoloadPaths as $autoloadPath) {
    if (file_exists($autoloadPath)) {
        require $autoloadPath;
        break;
    }
}

$cwd = getcwd();
$noColor = getenv('NO_COLOR') !== false;
$printer = new Printer(STDOUT, $noColor);

if ($cwd === false) {
    throw new LogicException('Cannot determine current working directory via getcwd()');
}

try {
    $initializer = new Initializer();
    $initResult = $initializer->initialize($cwd, $argv);
    $verbose = $initResult->cliOptions->verbose;

    $pathHelper = new PathHelper($cwd);
    $formatter = new ErrorFormatter($pathHelper, $printer, $initResult->config);
    $guard = new CoverageGuard($initResult->config, $printer, $pathHelper);
    $coverageReport = $guard->checkCoverage(
        $initResult->cliOptions->coverageFile,
        $initResult->cliOptions->patchFile,
        $initResult->cliOptions->verbose,
    );

    $exitCode = $formatter->formatReport($coverageReport);
    exit($exitCode);

} catch (HelpException $e) {
    $printer->printLine('');
    $printer->printLine($e->getMessage());
    $printer->printLine('');
    exit(1);

} catch (ErrorException $e) {
    $printer->printLine('');
    $printer->printLine('⚠️  <orange>Error:</orange> ' . $e->getMessage());
    $printer->printLine('');
    exit(1);

} catch (Throwable $e) {
    $printer->printLine('');
    $printer->printLine('‼️  <red>Internal error:</red> ' . $e::class . ': ' . $e->getMessage());
    $printer->printLine($e->getTraceAsString());
    exit(1);
}
